name: Generate Banners
on:
  schedule:
    - cron: '0 */6 * * *' # Runs every 6 hours
  workflow_dispatch: # Allows manual trigger from the Actions tab

jobs:
  screenshot:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          
      - name: Install Playwright
        run: |
          npm install playwright
          npx playwright install --with-deps chromium
        
      - name: Capture Banners
        run: |
          cat << 'EOF' > screenshot.js
          const { chromium } = require('playwright');
          (async () => {
            const browser = await chromium.launch();
            const context = await browser.newContext({ 
              viewport: { width: 1200, height: 1600 },
              deviceScaleFactor: 2 
            });
            const page = await context.newPage();
            
            // Set theme to dark
            await context.addCookies([{ 
              name: 'theme', 
              value: 'dark', 
              domain: 'zulfikar.site', 
              path: '/' 
            }]);
            
            await page.goto('https://zulfikar.site/github-profile', { 
              waitUntil: 'networkidle',
              timeout: 60000 
            });
            
            await page.addStyleTag({ 
              content: `
                header, footer, nav, [role="banner"], [role="contentinfo"] { display: none !important; } 
                #github-profile-export { background: transparent !important; padding: 20px !important; }
                body { background: transparent !important; }
              ` 
            });
            
            // Wait for hydration
            await page.waitForSelector('#github-profile-export:not(:has(.animate-pulse))', { timeout: 30000 });
            await page.waitForTimeout(2000);
            
            const element = await page.$('#github-profile-export');
            if (element) {
              await element.screenshot({ 
                path: 'banners.png', 
                omitBackground: true 
              });
            } else {
              process.exit(1);
            }
            
            await browser.close();
          })();
          EOF
          node screenshot.js

      - name: Update README timestamp
        run: |
          # Use UTC+7 (Asia/Jakarta) or system time, but standard date is fine.
          DATE=$(date +"%d/%m/%Y %H:%M")
          sed -i "s/Last updated: .*/Last updated: $DATE/" README.md
          
      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add banners.png README.md
          git commit -m "update profile banners and timestamp" || exit 0
          git push
